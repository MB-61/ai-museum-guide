<!DOCTYPE html>
<html class="dark" lang="tr">

<head>
    <meta charset="utf-8" />
    <meta
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=overlays-content"
        name="viewport" />
    <title>AI Müze Rehberi - KODE-X</title>
    <link rel="icon" type="image/png" href="/static/favicon.png" />

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-dark": "#1a2230",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                },
            },
        }
    </script>

    <!-- Azure Speech SDK -->
    <script
        src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>

    <!-- Three.js & TalkingHead -->
    <script type="importmap">
    { "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.module.js/+esm",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/",
        "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.7/modules/talkinghead.mjs"
    }}
    </script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/styles.css" />

    <style>
        /* Message styles */
        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .message.user {
            background: linear-gradient(135deg, #135bec, #1e40af);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.bot,
        .message.system {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
    </style>
</head>

<body class="bg-background-dark text-white font-display overflow-hidden select-none">

    <!-- Chat Screen -->
    <div class="flex flex-col h-screen w-full relative overflow-visible page-transition">

        <!-- Avatar + Background Area -->
        <div class="absolute inset-0 z-0 overflow-visible">
            <!-- Museum Background Image -->
            <div class="absolute inset-0 bg-cover bg-center bg-no-repeat"
                style="background-image: url('/static/museum-bg.png'); filter: blur(2px) brightness(0.4);"></div>

            <!-- Exhibit Frame (Right Side - Behind Avatar) -->
            <div id="exhibit-frame" class="absolute right-4 top-[12%] w-[50%] aspect-[3/4] z-5" style="display: none;">
                <div
                    class="relative w-full h-full bg-[#1a1a1a] rounded-2xl p-2 shadow-2xl border border-white/20 rotate-3">
                    <div class="w-full h-full rounded-xl overflow-hidden bg-gray-900 border border-white/10">
                        <img id="exhibit-image" alt="Eser" class="w-full h-full object-cover opacity-95" src=""
                            onerror="this.style.display='none'">
                        <div class="absolute inset-0 flex items-center justify-center" id="exhibit-placeholder">
                            <span class="material-symbols-outlined text-5xl text-slate-600">image</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Avatar (Left Side - In Front) -->
            <div id="avatar-container" class="absolute left-0 bottom-0 w-full h-[85%] z-10"
                style="transform: translateY(5%);"></div>

            <!-- Gradient overlay -->
            <div
                class="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-background-dark/80 pointer-events-none z-20">
            </div>
        </div>

        <!-- Top Bar -->
        <div
            class="relative z-20 flex items-center px-3 py-2 justify-between glass-panel border-b border-white/5 mx-3 mt-2 rounded-xl">
            <div class="flex items-center gap-2">
                <a href="index.html"
                    class="flex items-center justify-center size-8 rounded-full hover:bg-white/10 active:bg-white/20 transition-colors no-underline">
                    <span class="material-symbols-outlined text-white"
                        style="font-size: 20px;">arrow_back_ios_new</span>
                </a>
                <div class="flex flex-col">
                    <h2 class="text-white text-base font-bold leading-tight">KODE-X</h2>
                    <span id="mode-indicator" class="text-[10px] text-primary font-medium uppercase">Asistan</span>
                </div>
            </div>
            <div id="exhibit-badge" class="flex items-center bg-white/10 px-2 py-1 rounded-lg border border-white/10"
                style="display: none;">
                <span class="material-symbols-outlined text-primary mr-1"
                    style="font-size: 14px;">qr_code_scanner</span>
                <p id="exhibit-name" class="text-white text-xs font-bold truncate max-w-[100px]">Eser</p>
            </div>
        </div>

        <!-- Status Text -->
        <div class="flex-1 relative z-10 flex flex-col items-center justify-center pointer-events-none">
            <div id="status-floating" class="mt-auto mb-10 px-6 text-center">
                <p id="status-text" class="text-white/80 text-lg font-medium text-shadow animate-float">Yükleniyor...
                </p>
            </div>
        </div>

        <!-- Start Overlay -->
        <div id="start-overlay"
            class="absolute inset-0 z-40 flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300"
            style="display: none;">
            <button onclick="startExperience()"
                class="group relative px-8 py-4 bg-primary hover:bg-blue-600 text-white text-xl font-bold rounded-full shadow-lg hover:shadow-primary/50 transition-all transform hover:scale-105 active:scale-95">
                <span class="relative z-10 flex items-center gap-2">
                    <span class="material-symbols-outlined text-3xl">play_circle</span>
                    Sohbete Başla
                </span>
                <div class="absolute inset-0 rounded-full bg-white/20 animate-pulse"></div>
            </button>
        </div>

        <!-- Messages Container -->
        <div id="messages-panel" class="relative z-30 w-full px-4 mb-4" style="display: none;">
            <div class="glass-panel rounded-xl overflow-hidden max-w-md mx-auto">
                <div class="flex justify-center pt-2 pb-1 w-full cursor-pointer" onclick="toggleMessages()">
                    <div class="h-1 w-12 rounded-full bg-white/20"></div>
                </div>
                <div id="messages" class="max-h-32 overflow-y-auto no-scrollbar px-4 pb-4"></div>
            </div>
        </div>

        <!-- Bottom Interaction Zone -->
        <div class="relative z-30 flex flex-col items-center w-full px-4 pb-20 gap-4">
            <!-- Chat Input (Hidden by default) -->
            <div id="chat-input-panel" class="w-full max-w-md glass-panel rounded-xl p-3" style="display: none;">
                <div class="flex items-center gap-3">
                    <input type="text" id="chat-input" placeholder="Mesajınızı yazın..."
                        class="flex-1 bg-transparent text-white text-sm border-none focus:ring-0 placeholder:text-slate-400 disabled:opacity-50"
                        onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" id="send-btn"
                        class="bg-primary hover:bg-blue-600 text-white p-2 rounded-lg transition-colors disabled:opacity-50">
                        <span class="material-symbols-outlined" style="font-size: 20px;">send</span>
                    </button>
                </div>
            </div>

            <!-- Main Controls -->
            <div class="flex items-center justify-center gap-6 w-full max-w-md">

                <!-- Stop Button (Hidden when not speaking) -->
                <button id="stop-btn" onclick="stopSpeech()"
                    class="flex items-center justify-center size-12 rounded-full glass-panel text-red-400 hover:bg-red-500/20 transition-all border border-red-500/50"
                    style="display: none;">
                    <span class="material-symbols-outlined">stop</span>
                </button>

                <!-- Placeholder when stop hidden -->
                <div id="stop-placeholder" class="size-12"></div>

                <!-- Primary Microphone Button -->
                <div class="relative group">
                    <div id="mic-pulse-1"
                        class="absolute inset-0 bg-red-500/50 rounded-full animate-ping opacity-0 duration-[3s] pointer-events-none">
                    </div>
                    <div id="mic-pulse-2"
                        class="absolute inset-[-4px] bg-red-500/30 rounded-full animate-pulse opacity-0 pointer-events-none">
                    </div>
                    <button id="mic-btn"
                        class="relative flex size-20 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-gradient-to-tr from-primary to-blue-500 text-white shadow-[0_0_40px_-10px_rgba(19,91,236,0.6)] hover:scale-105 active:scale-95 transition-all duration-300 z-10 border-4 border-background-dark/30">
                        <span id="mic-icon" class="material-symbols-outlined" style="font-size: 36px;">mic</span>
                    </button>
                </div>

                <!-- Text Input Toggle -->
                <button id="toggle-input-btn" onclick="toggleChatInput()"
                    class="flex items-center justify-center size-12 rounded-full glass-panel text-white hover:bg-white/10 transition-all border border-white/10">
                    <span class="material-symbols-outlined">edit_note</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed top-6 left-1/2 -translate-x-1/2 z-50 glass-panel px-6 py-3 rounded-full flex items-center gap-3 opacity-0 transition-all duration-300 -translate-y-4">
        <span id="toast-icon" class="material-symbols-outlined text-primary">check_circle</span>
        <span id="toast-message" class="text-sm font-medium">Mesaj</span>
    </div>

    <!-- JavaScript -->
    <script type="module">
        import { TalkingHead } from "talkinghead";
        import { loadAzureConfig, loadGreetings, getRandomGreeting, API_BASE, AZURE_KEY, AZURE_REGION, QR_EXHIBITS } from './js/config.js';
        import { showToast, setStatus, getUrlParam, setupMobileKeyboard, setupStatusObserver } from './js/utils.js';

        // ========== STATE ==========
        let qrMode = false;
        let currentQrId = null;
        let currentExhibitTitle = null;

        let head = null;
        let isAvatarReady = false;
        let audioContext = null;
        let morphMeshes = [];

        let conversationHistory = [];
        let currentAudioSource = null;
        let isSpeaking = false;
        let lipSyncAnimationId = null;

        let recognition = null;
        let isListening = false;
        let silenceTimer = null;
        const SILENCE_TIMEOUT = 7000;

        // ========== VISEME CONFIG ==========
        const visemeConfig = {
            0: { name: "sil", intensity: 0 },
            1: { name: "aa", intensity: 0.8 },
            2: { name: "aa", intensity: 0.7 },
            3: { name: "O", intensity: 0.7 },
            4: { name: "E", intensity: 0.6 },
            5: { name: "I", intensity: 0.5 },
            6: { name: "I", intensity: 0.5 },
            7: { name: "U", intensity: 0.7 },
            8: { name: "O", intensity: 0.6 },
            9: { name: "aa", intensity: 0.7 },
            10: { name: "O", intensity: 0.6 },
            11: { name: "I", intensity: 0.5 },
            12: { name: "kk", intensity: 0.4 },
            13: { name: "RR", intensity: 0.5 },
            14: { name: "nn", intensity: 0.4 },
            15: { name: "SS", intensity: 0.5 },
            16: { name: "CH", intensity: 0.6 },
            17: { name: "TH", intensity: 0.5 },
            18: { name: "FF", intensity: 0.6 },
            19: { name: "DD", intensity: 0.5 },
            20: { name: "kk", intensity: 0.4 },
            21: { name: "PP", intensity: 0.8 }
        };

        const visemeNames = ['sil', 'aa', 'E', 'I', 'O', 'U', 'PP', 'FF', 'TH', 'DD', 'kk', 'CH', 'SS', 'nn', 'RR'];
        let currentVisemeValues = {};
        visemeNames.forEach(v => currentVisemeValues[v] = 0);

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAzureConfig();
            await loadGreetings();

            // Get URL parameters
            const mode = getUrlParam('mode');
            const qrId = getUrlParam('qr_id');

            if (mode === 'qr' && qrId) {
                qrMode = true;
                currentQrId = qrId;
            }

            setupMobileKeyboard();
            setupStatusObserver();
            initChatScreen();
        });

        // ========== CHAT SCREEN INIT ==========
        async function initChatScreen() {
            const modeIndicator = document.getElementById('mode-indicator');
            const exhibitBadge = document.getElementById('exhibit-badge');
            const exhibitFrame = document.getElementById('exhibit-frame');
            const exhibitImage = document.getElementById('exhibit-image');
            const exhibitName = document.getElementById('exhibit-name');
            const avatarContainer = document.getElementById('avatar-container');

            if (qrMode && currentQrId) {
                // Fetch exhibit details from API
                try {
                    const resp = await fetch(`${API_BASE}/qr/exhibit-image/${currentQrId}`);
                    const data = await resp.json();

                    if (data.title) {
                        currentExhibitTitle = data.title;
                    } else {
                        currentExhibitTitle = QR_EXHIBITS[currentQrId] || `Eser ${currentQrId.replace('qr_', '')}`;
                    }

                    modeIndicator.textContent = 'Eser Modu';
                    exhibitBadge.style.display = 'flex';
                    exhibitName.textContent = currentExhibitTitle;

                    // Show exhibit image if available
                    if (data.image) {
                        exhibitImage.src = data.image;
                        exhibitImage.style.display = 'block';
                        document.getElementById('exhibit-placeholder').style.display = 'none';

                        exhibitFrame.style.display = 'block';
                        avatarContainer.style.left = '0';
                        avatarContainer.style.right = 'auto';
                        avatarContainer.style.width = '70%';
                        avatarContainer.style.height = '100%';
                        avatarContainer.style.transform = 'translateX(-18%) translateY(40%) scale(1.8)';
                    } else {
                        throw new Error('No image');
                    }
                } catch (e) {
                    console.log('Could not load exhibit info:', e);
                    // Fallback UI
                    exhibitFrame.style.display = 'none';
                    avatarContainer.style.left = '50%';
                    avatarContainer.style.right = 'auto';
                    avatarContainer.style.width = '70%';
                    avatarContainer.style.height = '100%';
                    avatarContainer.style.transform = 'translateX(-50%) translateY(45%) scale(1.8)';
                }
            } else {
                modeIndicator.textContent = 'Genel Mod';
                exhibitBadge.style.display = 'none';
                exhibitFrame.style.display = 'none';
                avatarContainer.style.left = '50%';
                avatarContainer.style.right = 'auto';
                avatarContainer.style.width = '70%';
                avatarContainer.style.height = '100%';
                avatarContainer.style.transform = 'translateX(-50%) translateY(45%) scale(1.8)';
            }

            initAvatar();
            initSpeechRecognition();
        }

        // ========== AVATAR ==========
        async function initAvatar() {
            setStatus('Avatar yükleniyor...');

            try {
                const nodeAvatar = document.getElementById('avatar-container');
                head = new TalkingHead(nodeAvatar, {
                    ttsEndpoint: null,
                    lipsyncModules: ["en"],
                    cameraView: "full",
                    cameraRotateEnable: false
                });

                await head.showAvatar({
                    url: '/static/avatar.glb',
                    body: 'M',
                    avatarMood: 'neutral',
                    lipsyncLang: 'en'
                }, (ev) => {
                    if (ev.lengthComputable) {
                        const pct = Math.round((ev.loaded / ev.total) * 100);
                        setStatus(`Yükleniyor: ${pct}%`);
                    }
                });

                // Get morph meshes for lip sync
                morphMeshes = [];
                if (head?.scene) {
                    head.scene.traverse(node => {
                        if (node.isMesh && node.morphTargetDictionary && node.morphTargetInfluences) {
                            const visemeKeys = Object.keys(node.morphTargetDictionary).filter(k => k.startsWith('viseme_'));
                            if (visemeKeys.length > 0) {
                                console.log('Found viseme mesh:', node.name, visemeKeys);
                                morphMeshes.push({
                                    mesh: node,
                                    dict: node.morphTargetDictionary,
                                    influences: node.morphTargetInfluences
                                });
                            }
                        }
                    });
                }

                console.log('Total morph meshes found:', morphMeshes.length);

                isAvatarReady = true;
                setStatus('Hazır');
                showToast('Avatar hazır', 'success');

                // Show Start Overlay instead of auto-speaking
                document.getElementById('start-overlay').style.display = 'flex';
                setStatus('Başlamak için dokunun');

                // Pre-calculate greeting but don't speak yet
                window.pendingGreeting = getRandomGreeting(qrMode, currentExhibitTitle);

            } catch (err) {
                console.error('Avatar load error:', err);
                setStatus('Avatar yüklenemedi');
                showToast('Avatar yüklenemedi', 'error');
            }
        }

        window.startExperience = async function () {
            const overlay = document.getElementById('start-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.display = 'none', 300);

            // Unlock Audio Context
            await initAudioContext();

            // Speak Pending Greeting
            if (window.pendingGreeting) {
                addSystemMessage(window.pendingGreeting);
                speakWithAvatar(window.pendingGreeting);
                window.pendingGreeting = null;
            }
        };

        // ========== AUDIO & LIP SYNC ==========
        async function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') await audioContext.resume();
            return audioContext;
        }

        function pcmToAudioBuffer(pcmData, sampleRate) {
            const audioBuffer = audioContext.createBuffer(1, pcmData.length, sampleRate);
            const channelData = audioBuffer.getChannelData(0);
            for (let i = 0; i < pcmData.length; i++) {
                channelData[i] = pcmData[i] / 32768.0;
            }
            return audioBuffer;
        }

        function playAudioBuffer(audioBuffer) {
            return new Promise(resolve => {
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.onended = () => {
                    currentAudioSource = null;
                    resolve();
                };
                currentAudioSource = source;
                source.start();
            });
        }

        window.stopSpeech = function (silent = false) {
            if (currentAudioSource) {
                try { currentAudioSource.stop(); } catch (e) { }
                currentAudioSource = null;
            }
            if (lipSyncAnimationId) {
                cancelAnimationFrame(lipSyncAnimationId);
                lipSyncAnimationId = null;
            }
            isSpeaking = false;
            resetVisemes();
            setStatus('Durduruldu');
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('stop-placeholder').style.display = 'block';

            const micBtn = document.getElementById('mic-btn');
            micBtn.classList.remove('from-gray-500', 'to-gray-600', 'from-red-500', 'to-red-600');
            micBtn.classList.add('from-primary', 'to-blue-500');
            micBtn.disabled = false;

            document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-input').placeholder = 'Mesajınızı yazın...';
            document.getElementById('send-btn').disabled = false;

            if (!silent) {
                showToast('Konuşma durduruldu', 'info');
            }
        };

        function setVisemeSmooth(targetViseme, targetIntensity, lerpSpeed = 0.35) {
            visemeNames.forEach(v => {
                const target = (v === targetViseme) ? targetIntensity : 0;
                currentVisemeValues[v] += (target - currentVisemeValues[v]) * lerpSpeed;

                const fullName = 'viseme_' + v;
                morphMeshes.forEach(m => {
                    const idx = m.dict[fullName];
                    if (idx !== undefined) {
                        m.influences[idx] = Math.max(0, currentVisemeValues[v]);
                    }
                });
            });
        }

        function resetVisemes() {
            visemeNames.forEach(v => currentVisemeValues[v] = 0);
            morphMeshes.forEach(m => {
                Object.keys(m.dict).forEach(key => {
                    if (key.startsWith('viseme_')) {
                        m.influences[m.dict[key]] = 0;
                    }
                });
            });
        }

        async function animateLipSync(visemeData, totalDuration) {
            if (visemeData.length === 0) return;

            const startTime = performance.now();
            let currentIdx = 0;

            return new Promise(resolve => {
                function update() {
                    if (!isSpeaking) {
                        resetVisemes();
                        resolve();
                        return;
                    }

                    const elapsed = performance.now() - startTime;

                    while (currentIdx < visemeData.length - 1 && visemeData[currentIdx + 1].time <= elapsed) {
                        currentIdx++;
                    }

                    const current = visemeData[currentIdx];
                    const config = visemeConfig[current.id] || { name: "sil", intensity: 0 };
                    setVisemeSmooth(config.name, config.intensity);

                    if (elapsed < totalDuration * 1000 && isSpeaking) {
                        lipSyncAnimationId = requestAnimationFrame(update);
                    } else {
                        let fadeStep = 0;
                        function fadeOut() {
                            fadeStep++;
                            setVisemeSmooth("sil", 0, 0.2);
                            if (fadeStep < 10) {
                                requestAnimationFrame(fadeOut);
                            } else {
                                resetVisemes();
                                lipSyncAnimationId = null;
                                resolve();
                            }
                        }
                        fadeOut();
                    }
                }
                lipSyncAnimationId = requestAnimationFrame(update);
            });
        }

        async function speakWithAvatar(text) {
            // STOP any existing speech immediately to prevent overlap (silent mode)
            stopSpeech(true);

            if (!AZURE_KEY || AZURE_KEY === 'YOUR_AZURE_SPEECH_KEY_HERE') {
                showToast('Azure API anahtarı gerekli', 'error');
                setStatus('API anahtarı eksik');
                return;
            }

            setStatus('Konuşuyor...');
            isSpeaking = true;

            document.getElementById('stop-btn').style.display = 'flex';
            document.getElementById('stop-placeholder').style.display = 'none';

            const micBtn = document.getElementById('mic-btn');
            micBtn.classList.remove('from-primary', 'to-blue-500', 'from-red-500', 'to-red-600');
            micBtn.classList.add('from-gray-500', 'to-gray-600');

            document.getElementById('mic-pulse-1').classList.add('opacity-0');
            document.getElementById('mic-pulse-2').classList.add('opacity-0');

            // Force hide input panel
            const inputPanel = document.getElementById('chat-input-panel');
            if (inputPanel) inputPanel.style.display = 'none';

            document.getElementById('chat-input').disabled = true;
            document.getElementById('chat-input').placeholder = 'AI konuşuyor...';
            document.getElementById('send-btn').disabled = true;

            await initAudioContext();

            const voiceName = 'tr-TR-AhmetNeural';
            const ssml = `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xmlns:mstts="http://www.w3.org/2001/mstts" xml:lang="tr-TR">
                <voice name="${voiceName}">
                    <mstts:viseme type="redlips_front"/>
                    ${text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                </voice>
            </speak>`;

            const config = SpeechSDK.SpeechConfig.fromSubscription(AZURE_KEY, AZURE_REGION);
            config.speechSynthesisOutputFormat = SpeechSDK.SpeechSynthesisOutputFormat.Raw24Khz16BitMonoPcm;

            const synth = new SpeechSDK.SpeechSynthesizer(config, null);
            const visemeData = [];

            synth.visemeReceived = (s, e) => {
                visemeData.push({ id: e.visemeId, time: e.audioOffset / 10000 });
            };

            return new Promise((resolve, reject) => {
                synth.speakSsmlAsync(ssml,
                    async result => {
                        if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                            const pcmData = new Int16Array(result.audioData);
                            const audioBuffer = pcmToAudioBuffer(pcmData, 24000);

                            await Promise.all([
                                playAudioBuffer(audioBuffer),
                                animateLipSync(visemeData, audioBuffer.duration)
                            ]);

                            isSpeaking = false;
                            document.getElementById('stop-btn').style.display = 'none';
                            document.getElementById('stop-placeholder').style.display = 'block';
                            setStatus('Hazır');

                            const micBtn = document.getElementById('mic-btn');
                            micBtn.classList.remove('from-gray-500', 'to-gray-600', 'from-red-500', 'to-red-600');
                            micBtn.classList.add('from-primary', 'to-blue-500');
                            micBtn.disabled = false;

                            document.getElementById('chat-input').disabled = false;
                            document.getElementById('chat-input').placeholder = 'Mesajınızı yazın...';
                            document.getElementById('send-btn').disabled = false;

                            resolve();
                        } else {
                            isSpeaking = false;
                            document.getElementById('stop-btn').style.display = 'none';
                            setStatus('TTS hatası');
                            reject(result.errorDetails);
                        }
                        synth.close();
                    },
                    error => {
                        isSpeaking = false;
                        document.getElementById('stop-btn').style.display = 'none';
                        setStatus('Bağlantı hatası');
                        synth.close();
                        reject(error);
                    }
                );
            });
        }

        // ========== CHAT ==========
        window.sendMessage = async function () {
            const input = document.getElementById('chat-input');
            const question = input.value.trim();
            if (!question) return;

            addMessage(question, 'user');
            input.value = '';
            document.getElementById('chat-input-panel').style.display = 'none';
            input.blur(); // Dismiss mobile keyboard
            showMessagesPanel();
            setStatus('Düşünüyor...');

            input.disabled = true;
            input.placeholder = 'AI düşünüyor...';
            document.getElementById('send-btn').disabled = true;

            const micBtn = document.getElementById('mic-btn');
            micBtn.classList.remove('from-primary', 'to-blue-500', 'from-red-500', 'to-red-600');
            micBtn.classList.add('from-gray-500', 'to-gray-600');
            micBtn.disabled = true;

            try {
                const payload = {
                    question,
                    history: conversationHistory
                };
                if (qrMode && currentQrId) {
                    payload.qr_id = currentQrId;
                }

                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                addMessage(data.answer, 'bot');

                conversationHistory.push({ role: 'user', content: question });
                conversationHistory.push({ role: 'assistant', content: data.answer });
                if (conversationHistory.length > 10) {
                    conversationHistory = conversationHistory.slice(-10);
                }

                await speakWithAvatar(data.answer);

            } catch (err) {
                console.error('Chat error:', err);
                addMessage('Üzgünüm, bir hata oluştu.', 'bot');
                setStatus('Hata');
            }
        };

        window.handleKeyPress = function (event) {
            if (event.key === 'Enter') sendMessage();
        };

        function addMessage(text, type) {
            const messages = document.getElementById('messages');
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        function addSystemMessage(text) {
            addMessage(text, 'system');
            showMessagesPanel();
        }

        function showMessagesPanel() {
            const panel = document.getElementById('messages-panel');
            const messages = document.getElementById('messages');
            panel.style.display = 'block';
            if (!window.messagesPanelOpened) {
                messages.style.display = 'none';
                window.messagesPanelOpened = true;
            }
        }

        window.toggleMessages = function () {
            const panel = document.getElementById('messages');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        };

        window.toggleChatInput = function () {
            const panel = document.getElementById('chat-input-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                document.getElementById('chat-input').focus();
            }
        };

        // ========== SPEECH RECOGNITION ==========
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                document.getElementById('mic-btn').style.display = 'none';
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'tr-TR';

            let finalTranscript = '';

            // Assign to window for reset access (semi-global)
            window.resetTranscript = () => { finalTranscript = ''; };

            recognition.onresult = (event) => {
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }

                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    if (result.isFinal) {
                        finalTranscript += result[0].transcript;
                    } else {
                        interimTranscript += result[0].transcript;
                    }
                }

                setStatus(interimTranscript || finalTranscript || 'Dinliyor...');

                if (finalTranscript) {
                    silenceTimer = setTimeout(() => {
                        if (finalTranscript.trim()) {
                            document.getElementById('chat-input').value = finalTranscript.trim();
                            sendMessage();
                            finalTranscript = '';
                        }
                        stopListening();
                    }, 1500);
                }
            };

            recognition.onend = () => {
                if (isListening) {
                    if (finalTranscript.trim()) {
                        document.getElementById('chat-input').value = finalTranscript.trim();
                        sendMessage();
                    }
                }
                stopListening();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopListening();
                if (event.error !== 'no-speech') {
                    showToast('Ses tanıma hatası', 'error');
                }
            };

            // Mic button handlers
            const micBtn = document.getElementById('mic-btn');

            micBtn.onmousedown = micBtn.ontouchstart = (e) => {
                e.preventDefault();
                if (!isSpeaking) startListening();
            };

            micBtn.onmouseup = micBtn.ontouchend = micBtn.onmouseleave = micBtn.ontouchcancel = () => {
                // Let silenceTimer or onend handle stopping
            };
        }

        function startListening() {
            if (!recognition || isListening || isSpeaking) return;

            // Reset transcript state from previous session
            if (window.resetTranscript) window.resetTranscript();

            isListening = true;
            setStatus('Dinliyor...');

            const micBtn = document.getElementById('mic-btn');
            micBtn.classList.remove('from-primary', 'to-blue-500', 'from-gray-500', 'to-gray-600');
            micBtn.classList.add('from-red-500', 'to-red-600');

            document.getElementById('mic-pulse-1').classList.remove('opacity-0');
            document.getElementById('mic-pulse-2').classList.remove('opacity-0');

            try {
                recognition.start();
            } catch (e) {
                console.log('Recognition already started');
            }
        }

        function stopListening() {
            if (!recognition) return;

            isListening = false;

            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }

            try {
                recognition.stop();
            } catch (e) { }

            const micBtn = document.getElementById('mic-btn');
            micBtn.classList.remove('from-red-500', 'to-red-600', 'from-gray-500', 'to-gray-600');
            micBtn.classList.add('from-primary', 'to-blue-500');

            document.getElementById('mic-pulse-1').classList.add('opacity-0');
            document.getElementById('mic-pulse-2').classList.add('opacity-0');

            if (!isSpeaking) {
                setStatus('Hazır');
            }
        }
    </script>
</body>

</html>