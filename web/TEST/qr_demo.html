<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>QR Webcam Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto;
        padding: 16px;
      }
      #reader {
        width: 360px;
        max-width: 100%;
      }
      pre {
        background: #f6f6f6;
        padding: 12px;
        border-radius: 12px;
        overflow: auto;
      }
      .row {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr;
      }
      input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
        width: 100%;
      }
      button {
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
    </style>
    <script src="https://unpkg.com/html5-qrcode"></script>
  </head>

  <body>
    <h2>Webcam QR Scan → Museum API</h2>

    <div class="row">
      <div>
        <div id="reader"></div>
        <p><small>QR okunduğunda otomatik olarak API’ye istek atar.</small></p>
      </div>

      <div>
        <label>API Base URL (backend)</label>
        <input id="apiBase" value="http://127.0.0.1:8000" />

        <p class="btn-row">
          <button id="stopBtn">Stop Camera</button>
          <button id="toggleBtn">Switch Camera (Front)</button>
        </p>

        <h3>Output</h3>
        <pre id="out">Waiting…</pre>
      </div>
    </div>

    <script>
      const out = document.getElementById("out");
      const apiBase = document.getElementById("apiBase");
      const stopBtn = document.getElementById("stopBtn");
      const toggleBtn = document.getElementById("toggleBtn");

      const qr = new Html5Qrcode("reader");

      let currentFacing = "environment"; // default: back camera
      let isRunning = false;

      function extractQrId(text) {
        // Eğer QR URL ise .../q/<qr_id> formatından çek
        try {
          const url = new URL(text);
          const parts = url.pathname.split("/").filter(Boolean);
          const qIndex = parts.indexOf("q");
          if (qIndex !== -1 && parts[qIndex + 1]) return parts[qIndex + 1];
        } catch (e) {}
        return String(text || "").trim(); // plain id
      }

      async function postJson(url, body) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const txt = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${txt}`);
        return JSON.parse(txt);
      }

      async function onScan(decodedText) {
        const qr_id = extractQrId(decodedText);
        out.textContent = `QR read: ${qr_id}\n\nCalling /qr/lookup…`;

        // Önce lookup (kart bilgisi)
        const lookup = await postJson(`${apiBase.value}/api/v1/qr/lookup`, {
          qr_id,
        });

        out.textContent = `LOOKUP:\n${JSON.stringify(
          lookup,
          null,
          2
        )}\n\nCalling /chat…`;

        // Sonra örnek chat
        const chat = await postJson(`${apiBase.value}/api/v1/chat`, {
          qr_id,
          question: "Bu eser hakkında kısa bilgi verir misin?",
        });

        out.textContent = `LOOKUP:\n${JSON.stringify(
          lookup,
          null,
          2
        )}\n\nCHAT:\n${JSON.stringify(chat, null, 2)}`;
      }

      async function startScanner() {
        // Cihaz var mı diye kontrol (bazı tarayıcılarda izin sonrası label doluyor)
        const devices = await Html5Qrcode.getCameras();
        if (!devices || devices.length === 0) {
          out.textContent = "No camera found.";
          return;
        }

        // Her start'tan önce stop (özellikle iOS'ta gerekli olabiliyor)
        if (isRunning) {
          try {
            await qr.stop();
          } catch (e) {}
          isRunning = false;
        }

        out.textContent = `Starting camera… (${
          currentFacing === "environment" ? "back" : "front"
        })`;

        await qr.start(
          { facingMode: currentFacing }, // <-- back/front
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            // Aynı QR’ı üst üste spamlememek için kamerayı durduruyoruz
            try {
              await qr.stop();
            } catch (e) {}
            isRunning = false;

            try {
              await onScan(decodedText);
            } catch (err) {
              out.textContent = "Error: " + err.message;
            }
          }
        );

        isRunning = true;
        toggleBtn.textContent =
          currentFacing === "environment"
            ? "Switch Camera (Front)"
            : "Switch Camera (Back)";
      }

      stopBtn.onclick = async () => {
        try {
          await qr.stop();
        } catch (e) {}
        isRunning = false;
        out.textContent = "Camera stopped.";
      };

      toggleBtn.onclick = async () => {
        // switch facing mode
        currentFacing =
          currentFacing === "environment" ? "user" : "environment";

        try {
          out.textContent = `Switching camera… (${currentFacing})`;
          await startScanner();
        } catch (err) {
          out.textContent = "Error switching camera: " + err.message;
        }
      };

      (async () => {
        try {
          await startScanner();
        } catch (err) {
          out.textContent = "Error: " + err.message;
        }
      })();
    </script>
  </body>
</html>
